{% extends "base.html.twig" %}

{% block title %}Nouvelle facture{% endblock %}
{% block activeFacture %}class="active"{% endblock %}
{% block activeVentes2 %}show-m{% endblock %}

{% block body %}
<div class="page-content container-fluid">
  <div class="row mb-3">
    <div class="col-md-6"><h3>Nouvelle facture</h3></div>
    <div class="col-md-6 text-end">
      <button type="button" id="btn-save-draft" class="btn btn-info"><i class="fa fa-save"></i> Enregistrer</button>
    </div>
  </div>

  <div id="facture-form">
    <div class="mb-3">
      <label>Référence</label>
      <input type="text" id="reference" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>Client</label>
      <select id="client" class="form-control" required>
        {% for t in tiers %}
          <option value="{{ t.id }}">{{ t.nom }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label>Objet</label>
      <input type="text" id="objet" class="form-control" required>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
      <h4>Produits</h4>
      <div>
        <button type="button" id="addLigne" class="btn btn-outline-primary">+ Produit</button>
        <button type="button" id="addSectionBtn" class="btn btn-outline-success">+ Section</button>
      </div>
    </div>

    <div id="blocksContainer"></div>

    <div class="row mt-4">
      <div class="col-md-6">
        <label>Note</label>
        <textarea id="note" class="form-control" rows="4"></textarea>
      </div>
      <div class="col-md-6">
        <div class="card p-3">
          <div class="d-flex justify-content-between"><span>Total HT</span><span id="total_ht">0.00</span></div>
          <div class="d-flex justify-content-between"><span>Total TVA</span><span id="total_tva">0.00</span></div>
          <div class="d-flex justify-content-between"><span>Retenue source</span><span id="total_rs">0.00</span></div>
          <div class="d-flex justify-content-between"><span>Retenue garantie</span><span id="total_rg">0.00</span></div>
          <div class="d-flex justify-content-between border-top mt-2 pt-2"><strong>Total TTC</strong><strong id="total_ttc">0.00</strong></div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-end mt-4">
    <button type="button" id="btn-finalize" class="btn btn-success">Finaliser la facture</button>
  </div>
</div>

<!-- Modal de confirmation -->
<div id="modal-finaliser" class="modal" tabindex="-1"
     style="display:none; background:rgba(0,0,0,0.5); position:fixed; top:0;left:0;width:100%;height:100%;
            align-items:center;justify-content:center;">
  <div style="background:white;padding:20px;border-radius:8px;max-width:500px;width:100%;">
    <h5>Confirmer la finalisation</h5>
    <p>Voulez-vous vraiment finaliser cette facture ?</p>
    <div class="text-end mt-3">
      <button id="modal-cancel" class="btn btn-secondary">Annuler</button>
      <button id="modal-confirm" class="btn btn-success">Confirmer & Envoyer</button>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    console.log("Facture creation script loaded.");
  const container = document.getElementById('blocksContainer');
  const modal = document.getElementById('modal-finaliser');

  function createProductRow(index) {
    const div = document.createElement('div');
    div.className = 'card p-2 mb-2';
    div.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-3"><label>Produit</label><input class="form-control produit" placeholder="Nom du produit"></div>
        <div class="col-md-1"><label>Qté</label><input type="number" class="form-control qte" value="1"></div>
        <div class="col-md-2"><label>Prix HT</label><input type="number" class="form-control prix" value="0"></div>
        <div class="col-md-1"><label>Remise %</label><input type="number" class="form-control remise" value="0"></div>
        <div class="col-md-1"><label>TVA %</label><input type="number" class="form-control tva" value="20"></div>
        <div class="col-md-1"><label>RS %</label><input type="number" class="form-control rs" value="0"></div>
        <div class="col-md-1"><label>RG %</label><input type="number" class="form-control rg" value="0"></div>
        <div class="col-md-2"><label>Total TTC</label><input readonly class="form-control total-ttc" value="0.00"></div>
      </div>
    `;
    container.appendChild(div);
  }

  function createSection() {
    const div = document.createElement('div');
    div.className = 'card p-2 mb-2';
    div.innerHTML = `<label>Section</label><textarea class="form-control" rows="2"></textarea>`;
    container.appendChild(div);
  }
  function calcTotals() {
    let totalHT = 0, totalTVA = 0, totalRS = 0, totalRG = 0;
    container.querySelectorAll('.card').forEach(c => {
      const q = parseFloat(c.querySelector('.qte')?.value || 0);
      const p = parseFloat(c.querySelector('.prix')?.value || 0);
      const remise = parseFloat(c.querySelector('.remise')?.value || 0);
      const tva = parseFloat(c.querySelector('.tva')?.value || 0);
      const rs = parseFloat(c.querySelector('.rs')?.value || 0);
      const rg = parseFloat(c.querySelector('.rg')?.value || 0);
      const ht = q * p * (1 - remise / 100);
      const mtva = ht * (tva / 100);
      const ttc = ht + mtva;
      totalHT += ht;
      totalTVA += mtva;
      totalRS += ttc * rs / 100;
      totalRG += ttc * rg / 100;
      const totalInput = c.querySelector('.total-ttc');
      if (totalInput) totalInput.value = ttc.toFixed(2);
    });
    document.getElementById('total_ht').innerText = totalHT.toFixed(2);
    document.getElementById('total_tva').innerText = totalTVA.toFixed(2);
    document.getElementById('total_rs').innerText = totalRS.toFixed(2);
    document.getElementById('total_rg').innerText = totalRG.toFixed(2);
    document.getElementById('total_ttc').innerText = (totalHT + totalTVA).toFixed(2);
  }

  // === Boutons Ajouter Produit / Section ===
  document.getElementById('addLigne')?.addEventListener('click', () => {
    createProductRow(container.querySelectorAll('.card').length);
  });

  document.getElementById('addSectionBtn')?.addEventListener('click', () => {
    createSection();
  });

  // Calcul automatique sur changement
  container.addEventListener('input', calcTotals);

  // === Bouton Enregistrer ===
  document.getElementById('btn-save-draft')?.addEventListener('click', async () => {
    calcTotals();
    const data = {
      reference: document.getElementById('reference').value,
      client: document.getElementById('client').value,
      objet: document.getElementById('objet').value,
      note: document.getElementById('note').value,
      total_ht: document.getElementById('total_ht').innerText,
      total_tva: document.getElementById('total_tva').innerText,
      total_rs: document.getElementById('total_rs').innerText,
      total_rg: document.getElementById('total_rg').innerText,
      total_ttc: document.getElementById('total_ttc').innerText,
      finalize_action: 0
    };

    await fetch("{{ path('app_facture_create') }}", {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });

    // Redirection vers la liste des factures
    window.location.href = "{{ path('app_facture_index') }}";
  });

  // === Modale de finalisation ===
  document.getElementById('btn-finalize')?.addEventListener('click', () => {
    modal.style.display = 'flex';
  });

  document.getElementById('modal-cancel')?.addEventListener('click', () => {
    modal.style.display = 'none';
  });

  document.getElementById('modal-confirm')?.addEventListener('click', async () => {
    modal.style.display = 'none';
    calcTotals();

    const data = {
      reference: document.getElementById('reference').value,
      client: document.getElementById('client').value,
      objet: document.getElementById('objet').value,
      note: document.getElementById('note').value,
      total_ht: document.getElementById('total_ht').innerText,
      total_tva: document.getElementById('total_tva').innerText,
      total_rs: document.getElementById('total_rs').innerText,
      total_rg: document.getElementById('total_rg').innerText,
      total_ttc: document.getElementById('total_ttc').innerText,
      finalize_action: 1
    };

    await fetch("{{ path('app_facture_create') }}", {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });

    // Redirection vers la liste des factures après finalisation
    window.location.href = "{{ path('app_facture_index') }}";
  });
});
</script>
{% endblock %}
