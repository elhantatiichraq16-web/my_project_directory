{% extends "base.html.twig" %}

{% block title %}Nouvelle facture{% endblock %}

{% block activeFacture %}class="active"{% endblock %}
{% block activeVentes2 %}show-m{% endblock %}

{% block body %}

<style>
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align:center; vertical-align: top; }
    th { background-color: #1c3d61ff; color: white; }

    .sortable-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .sortable-block {
        background: #ffffff;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 1.25rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.2s ease;
    }

    .sortable-block.product-block {
        border-left: 4px solid #1c3d61ff;
    }

    .sortable-block.section-block {
        border-left: 4px solid #28a745;
    }

    .sortable-block:hover {
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }

    .block-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        flex-wrap: nowrap;
        gap: 0.75rem;
    }

    .block-header .title-group {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex: 1;
        min-width: 0;
    }

    .block-title {
        font-weight: 600;
        color: #1c3d61ff;
        white-space: nowrap;
    }

    .drag-handle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #edf2f9;
        color: #1c3d61ff;
        cursor: grab;
    }

    .drag-handle:active {
        cursor: grabbing;
    }

    .drag-handle i {
        pointer-events: none;
    }

    /* Bouton supprimer en ic√¥ne */
    .btn-delete-icon {
        background: transparent;
        border: none;
        color: #dc3545;
        font-size: 1.3rem;
        padding: 5px 10px;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 4px;
    }

    .btn-delete-icon:hover {
        background-color: #dc3545;
        color: white;
        transform: scale(1.1);
    }

    .block-content .form-label {
        font-weight: 600;
        color: #495057;
    }

    .product-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .product-grid .product-field {
        display: flex;
        flex-direction: column;
    }

    /* Description s√©par√©e */
    .product-description-field {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    @media (min-width: 992px) {
        .product-grid {
    display: grid !important;
    grid-template-columns: 1fr 1.35fr 0.75fr 1fr 0.75fr 0.75fr 1fr;
    gap: 1rem;
    align-items: end;
}

        .product-grid .product-field {
            margin-bottom: 0;
        }

        .product-grid .product-field .form-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 0.4rem;
        }
    }

    .btn {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
        transition: all 0.2s ease;
    }

    .btn-info {
        background-color: #2b4b6dff;
        color: white;
        border: none;
    }

    .btn-info:hover {
        background-color: #1c3d61ff;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border: none;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
        border: none;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .btn-outline-primary {
        background-color: transparent;
        border: 1px solid #132c46ff;
        color: #29405aff;
    }

    .btn-outline-primary:hover {
        background-color: #132c46ff;
        color: white;
    }

    .btn-outline-success {
        background-color: transparent;
        border: 1px solid #28a745;
        color: #28a745;
    }

    .btn-outline-success:hover {
        background-color: #28a745;
        color: white;
    }

    .btn-outline-danger {
        background-color: transparent;
        border: 1px solid #dc3545;
        color: #dc3545;
        padding: 8px 16px;
    }

    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: white;
    }

    .ligne { background-color: #f9f9f9; }
    .notification-err { font-size: 0.85rem; }
    .btn-envoyer { display: block; width: 100%; margin-top: 20px; font-size: 1.1rem; }
    .alert { padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; }
    .alert-success { background-color: #d1e7dd; color: #0f5132; }
    .alert-error { background-color: #f8d7da; color: #842029; }

    /* Styles pour la modale */
    .modal-header {
        background: linear-gradient(135deg, #1c3d61ff 0%, #2b4b6dff 100%);
        color: white;
        border-bottom: none;
    }

    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }

    .modal-body {
        padding: 2rem;
    }

    .invoice-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .summary-item {
        background: #f8f9fa;
        padding: 1.25rem;
        border-radius: 8px;
        border-left: 4px solid #2b4b6dff;
    }

    .summary-item label {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .summary-item .value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1c3d61ff;
    }

    .totals-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1.5rem 0;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 1rem;
        gap: 1rem;
    }

    .total-row label {
        margin-bottom: 0;
        color: #495057;
        min-width: 160px;
    }

    .total-row .value, .total-row input {
        font-weight: 600;
        color: #1c3d61ff;
        text-align: right;
        min-width: 140px;
    }

    .total-row.grand-total {
        border-top: 2px solid #2b4b6dff;
        padding-top: 1rem;
        margin-top: 1rem;
        font-size: 1.1rem;
    }

    .total-row.grand-total label,
    .total-row.grand-total .value {
        color: #2b4b6dff;
        font-weight: bold;
    }

    .modal-footer {
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
        padding: 1.25rem;
    }

    .modal-footer .btn {
        margin: 0 5px;
        padding: 10px 20px;
    }

    .btn-primary-modal {
        background-color: #2b4b6dff;
        color: white;
        border: none;
    }

    .btn-primary-modal:hover {
        background-color: #1c3d61ff;
    }

    .btn-warning-modal {
        background-color: #ffc107;
        color: #000;
        border: none;
    }

    .btn-warning-modal:hover {
        background-color: #ffb300;
    }

    .info-box {
        background: #e7f3ff;
        border-left: 4px solid #2b4b6dff;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
    }

    .info-box strong {
        color: #2b4b6dff;
    }

    .section-block textarea {
        background: #f8f9fa;
        border-left: 3px solid #28a745;
        font-style: italic;
    }
</style>

<div class="page-content">
    <div class="container-fluid">

    {# --- Flash messages --- #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }}">{{ message }}</div>
        {% endfor %}
    {% endfor %}

   <form id="form_facture" method="POST" action="{{ path('app_facture_edit', {'id': facture.id}) }}">
    <input type="hidden" name="_csrf_token" value="{{ csrf_token('submit') }}">


        <!-- Barre d'action -->
        <div class="row justify-content-md-center mb-2 d-flex align-items-center">
            <div class="col-md-6">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="#"><i class="fa-solid fa-house"></i></a></li>
                        <li class="breadcrumb-item"><a href="#">Ventes</a></li>
                        <li class="breadcrumb-item"><a href="/factures">Liste des factures</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Nouvelle facture</li>
                    </ol>
                </nav>
            </div>
            <div class="col-md-6 text-end">
                <button type="button" id="btn-save-draft" class="btn btn-info"><i class="fa-regular fa-floppy-disk"></i> Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="window.history.back();"><i class="far fa-window-close"></i> Annuler</button>
            </div>
        </div>

        <!-- Formulaire principal -->
        <div class="row justify-content-md-center mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h3>Cr√©er une nouvelle facture
                            <span class="badge bg-danger notification-err" id="n_err_facture" style="visibility:hidden;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span id="n_err_facture_c">0</span>
                            </span>
                        </h3>

                        <div class="row">
                            <!-- Colonne gauche -->
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label>R√©f√©rence Facture <span style="color:red">*</span> :</label>
                         <input type="text" name="reference" placeholder="FAC-2025-001" value="{{ facture.reference }}" required>
                                   </div>
                                <div class="mb-2">
                                    <label>Client <span style="color:red">*</span> :</label>
                                    <select name="tier" required>
                                       <option value="">-- S√©lectionner --</option>
{% for t in tiers %}
    <option value="{{ t.id }}" {% if facture.tier and facture.tier.id == t.id %}selected{% endif %}>{{ t.nom }}</option>
{% endfor %}
                        </select>
                                </div>
                               <div class="mb-2">
                                   <label>Date de facture <span style="color:red">*</span> :</label>
                                      <input
                                       type="date"
                                       name="date_creation"
                                   value="{{ facture.dateCreation ? facture.dateCreation|date("Y-m-d") : "now"|date("Y-m-d") }}"
                                     required
                                      >
                                </div>

                                <div class="mb-2">
                                    <label>Date d'√©ch√©ance :</label>
                                    <input type="date" name="date_echeance" value="{{ facture.dateEcheance ? facture.dateEcheance|date("Y-m-d") : '' }}">
                                </div>
                                <div class="mb-2">
                                    <label>√âtat :</label>
                                    <select name="etat">
                                       <option value="Brouillon" {% if facture.etat == 'Brouillon' %}selected{% endif %}>Brouillon</option>
<option value="Valid√©e" {% if facture.etat == 'Valid√©e' %}selected{% endif %}>Valid√©e</option>
<option value="Envoy√©e" {% if facture.etat == 'Envoy√©e' %}selected{% endif %}>Envoy√©e</option>
<option value="Pay√©e" {% if facture.etat == 'Pay√©e' %}selected{% endif %}>Pay√©e</option>
<option value="Annul√©e" {% if facture.etat == 'Annul√©e' %}selected{% endif %}>Annul√©e</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Colonne droite -->
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <label>Objet <span style="color:red">*</span> :</label>
                                    <input type="text" name="objet" placeholder="Objet de la facture" value="{{ facture.objet }}" required>
                                </div>
                                <div class="mb-2">
                                    <label>Devise :</label>
                                    <select name="devise">
                                        {% for d in devises %}
    <option value="{{ d }}" {% if facture.devise == d %}selected{% endif %}>{{ d }}</option>
{% endfor %}
                                    </select>
                                </div>
                                </div>

                            {# note initiale removed from here - will be placed near totals #}
                        </div>

                        <hr>
                        <div class="product-section mt-4">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h3 class="mb-0 fw-bold text-primary pb-2">Produits de la facture</h3>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary" id="addLigne">
                                        <i class="fa-solid fa-plus me-1"></i> Ajouter un produit
                                    </button>
                                    <button type="button" class="btn btn-outline-success" id="addSectionBtn">
                                        <i class="fa-solid fa-plus me-1"></i> Ajouter une section
                                    </button>
                                </div>
                            </div>
                          <!-- Replace the blocksContainer section in edit.html.twig with this -->
<div id="blocksContainer" class="sortable-container">
{% for ligne in facture.lignes %}
<div class="sortable-block product-block">
    <div class="product-line" style="
        display: grid;
        grid-template-columns: 1.1fr 1.1fr 0.6fr 0.6fr 0.8fr 0.8fr 0.8fr 0.9fr 0.9fr 0.3fr;
        gap: 8px;
        align-items: end;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 10px;
        background: #fff;
        margin-bottom: 15px;
    ">

        <div>
            <label class="form-label">R√©f√©rence</label>
            <input type="text" name="produits[{{ loop.index0 }}][reference]" class="form-control"
                   value="{{ ligne.reference }}">
        </div>

        <div>
            <label class="form-label">Produit</label>
            <input type="text" name="produits[{{ loop.index0 }}][produit]" class="form-control"
                   value="{{ ligne.produit }}">
        </div>

        <div>
            <label class="form-label">Quantit√©</label>
            <input type="number" name="produits[{{ loop.index0 }}][quantite]" class="form-control"
                   value="{{ ligne.quantite }}" min="0" step="0.01">
        </div>

        <div>
            <label class="form-label">Unit√©</label>
            <input type="text" name="produits[{{ loop.index0 }}][unite]" class="form-control"
                   value="{{ ligne.unite }}">
        </div>

        <div>
            <label class="form-label">Prix HT</label>
            <input type="number" name="produits[{{ loop.index0 }}][prix_ht]" class="form-control"
                   value="{{ ligne.prixHt }}" step="0.01">
        </div>

        <div>
            <label class="form-label">Remise (%)</label>
            <select name="produits[{{ loop.index0 }}][remise]" class="form-control">
                {% for taux in [0, 5, 10, 15, 20] %}
                    <option value="{{ taux }}" {% if ligne.remise == taux %}selected{% endif %}>{{ taux }}%</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">TVA (%)</label>
            <select name="produits[{{ loop.index0 }}][tva]" class="form-control">
                {% for taux in [0, 5, 10, 15, 20] %}
                    <option value="{{ taux }}" {% if ligne.tva == taux %}selected{% endif %}>{{ taux }}%</option>
                {% endfor %}
            </select>
        </div>

        <div>
            <label class="form-label">Montant TVA</label>
            <input type="number" name="produits[{{ loop.index0 }}][montant_tva]" class="form-control"
                   value="{{ (ligne.quantite * ligne.prixHt * (1 - ligne.remise / 100) * (ligne.tva / 100))|number_format(2, '.', '') }}" readonly>
        </div>

        <div>
            <label class="form-label">Total TTC</label>
            <input type="number" name="produits[{{ loop.index0 }}][total_ttc]" class="form-control"
                   value="{{ ligne.totalTTC|number_format(2, '.', '') }}" step="0.01" readonly>
        </div>

        <div style="display:flex; align-items:center; justify-content:center;">
            <button type="button" class="deleteLigne" title="Supprimer" aria-label="Supprimer" style="
                background:#dc3545; border:none; color:white; width:36px; height:36px;
                border-radius:6px; display:flex; align-items:center; justify-content:center;
                cursor:pointer;">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        </div>

        <div style="grid-column: 1 / span 4; margin-top:8px;">
            <label class="form-label">Description du produit</label>
            <textarea name="produits[{{ loop.index0 }}][description]" class="form-control"
                      rows="1" style="resize: vertical; min-height: 35px; max-height: 100px;">{{ ligne.description }}</textarea>
        </div>
    </div>
</div>
{% endfor %}
</div>
                        </div>

                        <hr class="my-4">

                        <div class="row mt-4">
                     <!-- Note + retenues √† gauche -->
<div class="col-md-6">
    <label>Note :</label>
    <textarea name="notes" rows="6" class="form-control mb-3" placeholder="Ajouter une note..."></textarea>

    <div class="totals-section" style="padding: 0.75rem; background: #f8f9fa; border-radius: 8px;">
        
        <div class="total-row" style="margin-bottom: 0.5rem;">
            <label id="label-retenue-source" style="font-size: 0.9rem;">Retenue √† la source (%) :</label>
            <input type="number" name="retenue_source_globale" step="0.01" min="0" value="0"
                   style="width:80px; text-align:center; padding:4px; font-size:0.85rem;">
        </div>

        <div class="total-row">
            <label id="label-retenue-garantie" style="font-size: 0.9rem;">Retenue de garantie (%) :</label>
            <input type="number" name="retenue_garantie_globale" step="0.01" min="0" value="0"
                   style="width:80px; text-align:center; padding:4px; font-size:0.85rem;">
        </div>

        <div class="total-row">
            <label id="label-remise-globale" style="font-size: 0.9rem;">Remise globale (%) :</label>
            <input type="number" name="remise_globale" step="0.01" min="0"
                   value="{{ facture.remiseGlobale ?? 0 }}"
                   style="width:80px; text-align:center; padding:4px; font-size:0.85rem;">
        </div>

    </div>
</div>


<!-- Totaux √† droite -->
<div class="col-md-6">
    <div class="totals-section">

        <div class="total-row">
            <label>Total HT :</label>
            <input type="text" name="total_ht" readonly value="{{ totaux.total_ht|number_format(2, '.', '') }}">
        </div>

        <div class="total-row">
            <label id="label-remise-globale-droite">Remise globale :</label>
            <input type="text" name="total_remise" readonly 
                   value="{{ totaux.total_remise|number_format(2, '.', '') }}">
        </div>

        <div class="total-row">
            <label>Total TVA :</label>
            <input type="text" name="total_tva" readonly value="{{ totaux.total_tva|number_format(2, '.', '') }}">
        </div>

        <div class="total-row">
            <label id="label-retenue-source-droite">Retenue √† la source :</label>
            <input type="text" name="total_retenue_source" readonly 
                   value="{{ facture.retenueSource ? facture.retenueSource|number_format(2, '.', '') : '0.00' }}">
        </div>

        <div class="total-row">
            <label id="label-retenue-garantie-droite">Retenue de garantie :</label>
            <input type="text" name="total_retenue_garantie" readonly 
                   value="{{ facture.retenueGarantie ? facture.retenueGarantie|number_format(2, '.', '') : '0.00' }}">
        </div>

        <div class="total-row grand-total">
            <label>Total TTC :</label>
            <input type="text" name="total_ttc" readonly value="{{ totaux.total_ttc|number_format(2, '.', '') }}">
        </div>
    </div>

    <div class="text-center mt-3">
        <button type="button" id="btn-open-modal" class="btn btn-success btn-envoyer">
            <i class="fa-solid fa-paper-plane"></i> Finaliser la facture
        </button>
    </div>
</div>

    <!-- Modal Beautifully Designed -->
    <div class="modal fade" id="factureResumeModal" tabindex="-1" aria-labelledby="factureResumeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title mb-0" id="factureResumeModalLabel">
                            <i class="fas fa-file-invoice"></i> R√©sum√© de la Facture
                        </h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- Info Box -->
                    <div class="info-box">
                        <i class="fas fa-info-circle"></i>
                        <strong>V√©rifiez les informations</strong> avant de finaliser la facture.
                    </div>

                    <!-- Summary Grid -->
                    <div class="invoice-summary">
                        <div class="summary-item">
                            <label>R√©f√©rence</label>
                            <div class="value" id="modal-reference">-</div>
                        </div>
                        <div class="summary-item">
                            <label>Client</label>
                            <div class="value" id="modal-tier">-</div>
                        </div>
                        <div class="summary-item">
                            <label>Date de Facture</label>
                            <div class="value" id="modal-date-creation">-</div>
                        </div>
                        <div class="summary-item">
                            <label>Objet</label>
                            <div class="value" id="modal-objet">-</div>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-row">
                            <label><i class="fas fa-calculator"></i> Total HT</label>
                            <div class="value" id="modal-total-ht">0.00 MAD</div>
                        </div>
                        <div class="total-row">
                            <label><i class="fas fa-percentage"></i> Remise</label>
                            <div class="value" id="modal-total-remise">0.00 MAD</div>
                        </div>
                        <div class="total-row">
                            <label><i class="fas fa-receipt"></i> TVA</label>
                            <div class="value" id="modal-total-tva">0.00 MAD</div>
                        </div>
                        <div class="total-row grand-total">
                            <label><i class="fas fa-euro-sign"></i> Total TTC</label>
                            <div class="value" id="modal-total-ttc">0.00 MAD</div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                    <button type="button" id="modal-btn-email" class="btn btn-primary btn-primary-modal">
                        <i class="fas fa-envelope"></i> Envoyer par mail
                    </button>
                    <button type="button" id="modal-btn-print" class="btn btn-info" style="background-color: #17a2b8; color: white; border: none;">
                        <i class="fas fa-print"></i> Imprimer
                    </button>
                    <a href="#" id="modal-btn-pdf" class="btn btn-warning-modal" target="_blank">
                        <i class="fas fa-file-pdf"></i> T√©l√©charger PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<script>

// ‚úÖ Script de mise √† jour dynamique des labels (Remise globale, Retenue √† la source, Retenue de garantie)
document.addEventListener("DOMContentLoaded", function() {
    const inputRemiseGlobale = document.querySelector('input[name="remise_globale"]');
    const inputRetenueSource = document.querySelector('input[name="retenue_source_globale"]');
    const inputRetenueGarantie = document.querySelector('input[name="retenue_garantie_globale"]');

    const labelRemiseGlobale = document.getElementById('label-remise-globale');
    const labelRetenueSource = document.getElementById('label-retenue-source');
    const labelRetenueGarantie = document.getElementById('label-retenue-garantie');

    function updateLabel(input, label, baseText) {
        if (!input || !label) return;
        const update = () => {
            const value = parseFloat(input.value) || 0;
            label.textContent = value > 0 ? `${baseText} (${value}%) :` : `${baseText} :`;
        };
        input.addEventListener("input", update);
        update();
    }

    updateLabel(inputRemiseGlobale, labelRemiseGlobale, "Remise globale");
    updateLabel(inputRetenueSource, labelRetenueSource, "Retenue √† la source");
    updateLabel(inputRetenueGarantie, labelRetenueGarantie, "Retenue de garantie");
});

</script>

<script>
let factureId = null;
let myModal;
let sectionCount = 0;

// always show retenues according to user request
const showRetenueSource = true;
const showNetAPayer = true;
function createProductBlock(index) {
    const productBlock = document.createElement('div');
    productBlock.classList.add('sortable-block', 'product-block');

    let html = `
    <div class="product-line" style="
        display: grid;
        grid-template-columns: 1.1fr 1.1fr 0.6fr 0.6fr 0.8fr 0.8fr 0.8fr 0.9fr 0.9fr 0.3fr;
        gap: 8px;
        align-items: end;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 10px;
        background: #fff;
        margin-bottom: 15px;
    ">

        <div>
            <label class="form-label">R√©f√©rence</label>
            <input type="text" name="produits[${index}][reference]" class="form-control" value="">
        </div>

        <div>
            <label class="form-label">Produit</label>
            <input type="text" name="produits[${index}][produit]" class="form-control" value="">
        </div>

        <div>
            <label class="form-label">Quantit√©</label>
            <input type="number" name="produits[${index}][quantite]" class="form-control" value="1" min="0" step="0.01">
        </div>

        <div>
            <label class="form-label">Unit√©</label>
            <input type="text" name="produits[${index}][unite]" class="form-control" value="kg" placeholder="kg, L, m">
        </div>

        <div>
            <label class="form-label">Prix HT</label>
            <input type="number" name="produits[${index}][prix_ht]" class="form-control" value="0" step="0.01">
        </div>

       <div>
    <label class="form-label">Remise (%)</label>
    <select name="produits[${index}][remise]" class="form-control">
        <option value="0">0%</option>
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
    </select>
</div>

<div>
    <label class="form-label">TVA (%)</label>
    <select name="produits[${index}][tva]" class="form-control">
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20" selected>20%</option>
    </select>
</div>

<div>
    <label class="form-label">Montant TVA</label>
    <select name="produits[${index}][montant_tva]" class="form-control">
        <option value="5">5%</option>
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20" selected>20%</option>
    </select>
</div>


        <div>
            <label class="form-label">Total TTC</label>
            <input type="number" name="produits[${index}][total_ttc]" class="form-control" value="0" step="0.01" readonly>
        </div>

        <div style="display:flex; align-items:center; justify-content:center;">
            <button type="button" class="deleteLigne" title="Supprimer" aria-label="Supprimer" style="
                background:#dc3545; border:none; color:white; width:36px; height:36px;
                border-radius:6px; display:flex; align-items:center; justify-content:center;
                cursor:pointer;
            ">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        </div>

        <!-- üîπ Description compacte -->
        <div style="grid-column: 1 / span 4; margin-top:8px;">
            <label class="form-label">Description du produit</label>
            <textarea name="produits[${index}][description]" 
                      class="form-control" 
                      rows="1"
                      placeholder="Description..." 
                      style="resize: vertical; min-height: 35px; max-height: 100px;"></textarea>
        </div>
    </div>
    `;

    productBlock.innerHTML = html;
    return productBlock;
}


``
function calculateTotals() {
    let totalHT = 0;
    let totalTVA = 0;

    const productBlocks = document.querySelectorAll('#blocksContainer .product-block');

    // üîπ 1. Calcul par ligne (remise ligne appliqu√©e seulement sur la ligne)
    productBlocks.forEach(block => {
        const q = parseFloat(block.querySelector('[name*="[quantite]"]')?.value) || 0;
        const p = parseFloat(block.querySelector('[name*="[prix_ht]"]')?.value) || 0;
        const remiseLigne = parseFloat(block.querySelector('[name*="[remise]"]')?.value) || 0;
        const tva = parseFloat(block.querySelector('[name*="[tva]"]')?.value) || 0;

        // Calcul de la ligne avec remise ligne (affichage seulement)
        const htBrut = q * p;
        const montantRemiseLigne = htBrut * (remiseLigne / 100);
        const htNetLigne = htBrut - montantRemiseLigne;
        const montantTVA_Ligne = htNetLigne * (tva / 100);
        const totalLigneTTC = htNetLigne + montantTVA_Ligne;

        const ttcInput = block.querySelector('[name*="[total_ttc]"]');
        if (ttcInput) ttcInput.value = totalLigneTTC.toFixed(2);

        // Pour le total global, on additionne le HT brut (sans remise ligne)
        totalHT += htBrut;
        totalTVA += htBrut * (tva / 100); // TVA calcul√©e sur le HT brut (avant remise globale)
    });

    // üîπ 2. Calcul de la remise globale
    const remiseGlobaleTaux = parseFloat(document.querySelector('input[name="remise_globale"]')?.value) || 0;
    const montantRemiseGlobale = totalHT * (remiseGlobaleTaux / 100);

    // üîπ 3. Application de la remise globale sur le total HT
    const totalHTApresRemiseGlobale = totalHT - montantRemiseGlobale;

    // üîπ 4. Recalcul du total TVA apr√®s remise globale
    const totalTVAApresRemiseGlobale = totalHTApresRemiseGlobale * (totalTVA / totalHT || 0);
    const totalTTC = totalHTApresRemiseGlobale + totalTVAApresRemiseGlobale;

    // üîπ 5. Retenues globales (si pr√©sentes)
    const retenueSourceTaux = parseFloat(document.querySelector('input[name="retenue_source_globale"]')?.value) || 0;
    const retenueGarantieTaux = parseFloat(document.querySelector('input[name="retenue_garantie_globale"]')?.value) || 0;

    const montantRetenueSource = totalTTC * (retenueSourceTaux / 100);
    const montantRetenueGarantie = totalTTC * (retenueGarantieTaux / 100);

    // üîπ 6. Mise √† jour des champs totaux
    const totalHTField = document.querySelector('[name="total_ht"]');
    const totalRemiseField = document.querySelector('[name="total_remise"]');
    const totalTVAField = document.querySelector('[name="total_tva"]');
    const totalTTCField = document.querySelector('[name="total_ttc"]');
    const retenueSourceField = document.querySelector('[name="total_retenue_source"]');
    const retenueGarantieField = document.querySelector('[name="total_retenue_garantie"]');

    if (totalHTField) totalHTField.value = totalHT.toFixed(2);
    if (totalRemiseField) totalRemiseField.value = montantRemiseGlobale.toFixed(2);
    if (totalTVAField) totalTVAField.value = totalTVAApresRemiseGlobale.toFixed(2);
    if (totalTTCField) totalTTCField.value = totalTTC.toFixed(2);
    if (retenueSourceField) retenueSourceField.value = montantRetenueSource.toFixed(2);
    if (retenueGarantieField) retenueGarantieField.value = montantRetenueGarantie.toFixed(2);
}


function reindexProducts() {
    const blocks = document.querySelectorAll('#blocksContainer .product-block');
    blocks.forEach((block, index) => {
        // üîπ Ajout d'une s√©curit√© : ne plante plus s'il n'y a pas de block-title
        const title = block.querySelector('.block-title');
        if (title) {
            title.textContent = `Produit ${index + 1}`;
        }

        // üîπ Mise √† jour des attributs "name" pour chaque input/textarea
        block.querySelectorAll('input, textarea, select').forEach(field => {
            if (field.name) {
                field.name = field.name.replace(/produits\[\d+\]/, `produits[${index}]`);
            }
        });
    });
}


function reindexSections() {
    const sections = document.querySelectorAll('#blocksContainer .section-block');
    sections.forEach((section, index) => {
        const currentIndex = index + 1;
        const label = section.querySelector('label');
        const textarea = section.querySelector('textarea');
        if (label) {
            label.setAttribute('for', `section-${currentIndex}`);
            label.textContent = `Section ${currentIndex}`;
        }
        if (textarea) {
            textarea.id = `section-${currentIndex}`;
            textarea.name = `sections[${currentIndex}][contenu]`;
        }
    });
    sectionCount = sections.length;
}

function initSortable() {
    const blocksContainer = document.getElementById('blocksContainer');
    if (blocksContainer && typeof Sortable !== 'undefined') {
        Sortable.create(blocksContainer, {
            animation: 150,
            draggable: '.sortable-block',
            handle: '.drag-handle',
            onEnd: () => {
                reindexProducts();
                reindexSections();
                calculateTotals();
            }
        });
    }
}

document.addEventListener('click', e => {
    // supprimer une ligne : g√©rer le click sur l'ic√¥ne ou le bouton
    const deleteBtn = e.target.closest('.deleteLigne');
    if (deleteBtn) {
        const block = deleteBtn.closest('.product-block, .section-block');
        if (block) {
            block.remove();
            reindexProducts();
            reindexSections();
            calculateTotals();
        }
        return;
    }

    // supprimer section (ancien s√©lecteur pour compatibilit√©)
    const deleteSectionBtn = e.target.closest('.deleteSection');
    if (deleteSectionBtn) {
        const section = deleteSectionBtn.closest('.section-block');
        if (section) {
            section.remove();
            reindexSections();
            calculateTotals();
        }
        return;
    }
});

document.addEventListener('input', e => {
    if (!e.target) return;
    const name = e.target.name || '';
    if ([
        'quantite','prix_ht','remise','tva','retenue_source','retenue_garantie'
    ].some(n => name.includes(n))) {
        calculateTotals();
    }
});

var addLigneBtn = document.getElementById('addLigne');
if (addLigneBtn) addLigneBtn.addEventListener('click', () => {
    const container = document.getElementById('blocksContainer');
    const rowCount = container.querySelectorAll('.product-block').length;
    const newBlock = createProductBlock(rowCount);
    container.appendChild(newBlock);
    reindexProducts();
    initSortable(); // r√©-init pour s'assurer que les nouveaux √©l√©ments sont "draggables"
    calculateTotals();
});

var addSectionBtn = document.getElementById('addSectionBtn');
if (addSectionBtn) addSectionBtn.addEventListener('click', () => {
    sectionCount++;
    const container = document.getElementById('blocksContainer');
    const section = document.createElement('div');
    section.classList.add('sortable-block', 'section-block');
    section.innerHTML = `
        <div class="block-header">
            <div class="title-group">
                <span class="drag-handle" role="button" aria-label="D√©placer la section">
                    <i class="fa-solid fa-grip-vertical"></i>
                </span>
                <label for="section-${sectionCount}" class="form-label mb-0">Section ${sectionCount}</label>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm deleteSection">
                <i class="fa-solid fa-trash-can me-1"></i> Supprimer
            </button>
        </div>
        <div class="block-content">
            <textarea id="section-${sectionCount}" name="sections[${sectionCount}][contenu]" rows="4" class="form-control"></textarea>
        </div>
    `;
    container.appendChild(section);
    reindexSections();
    initSortable();
});

document.addEventListener('DOMContentLoaded', function () {
    initSortable();
    reindexProducts();
    reindexSections();
    calculateTotals();

    // gestion visibilit√© net √† payer (toujours affich√©e si demand√©)
    const netRow = document.querySelector('.net-a-payer-row');
    if (netRow) {
        netRow.style.display = showNetAPayer ? '' : 'none';
    }

    // Bouton "enregistrer" : envoie directement le formulaire (fallback simple)
    document.getElementById('btn-save-draft').addEventListener('click', function(e) {
        e.preventDefault();
        calculateTotals(); // s'assurer que les totaux sont √† jour
        const form = document.getElementById('form_facture');
        // essai AJAX si besoin - mais garantissons un fallback : submit classique
        try {
            const formData = new FormData(form);
            fetch(form.action, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: formData, credentials: 'same-origin' })
            .then(response => {
                // si response ok et json indique success, afficher message ; sinon fallback submit
                const ct = response.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    return response.json().then(data => ({ ok: response.ok, json: data }));
                }
                return { ok: response.ok, json: null };
            })
            .then(resp => {
                if (resp.json && resp.json.success) {
                    factureId = resp.json.factureId;
                    alert('Facture enregistr√©e comme brouillon.');
                } else if (!resp.json && resp.ok) {
                    form.submit();
                } else if (resp.json && !resp.json.success) {
                    //alert(resp.json.message || 'Erreur lors de l\\'enregistrement (serveur).');
                } else {
                    form.submit();
                }
            })
            .catch(err => {
                console.warn('Erreur AJAX, fallback submit :', err);
                form.submit();
            });
        } catch (err) {
            console.warn('Erreur, submit direct :', err);
            form.submit();
        }
    });

    // Bouton d'ouverture de la modale : v√©rification simple + envoi (simulate)
    if (typeof bootstrap !== 'undefined') {
        myModal = new bootstrap.Modal(document.getElementById('factureResumeModal'));

        document.getElementById('btn-open-modal').addEventListener('click', function(e) {
            e.preventDefault();
            calculateTotals(); // recalculer avant d'ouvrir
            const form = document.getElementById('form_facture');
            const formData = new FormData(form);

            if (!formData.get('reference') || !formData.get('tier') || !formData.get('date_creation') || !formData.get('objet')) {
                //alert('Veuillez remplir tous les champs obligatoires (*).');
                return;
            }

            // On essaye d'utiliser AJAX pour obtenir l'id, sinon on ouvre modal et invite √† enregistrer d'abord
            fetch(form.action, { method: 'POST', headers: {'X-Requested-With': 'XMLHttpRequest'}, body: formData, credentials: 'same-origin' })
            .then(response => response.json().catch(()=>({success:false})))
            .then(data => {
                if (data && data.success) {
                    factureId = data.factureId;
                } else {
                    factureId = null; // pas d'id, on laisse les boutons PDF/email non fonctionnels
                }

                const tierSelect = document.querySelector('select[name=\"tier\"]');
                const devise = formData.get('devise') || 'EUR';

                document.getElementById('modal-reference').textContent = formData.get('reference');
                document.getElementById('modal-tier').textContent = tierSelect ? tierSelect.options[tierSelect.selectedIndex].text : '-';
                document.getElementById('modal-date-creation').textContent = new Date(formData.get('date_creation')).toLocaleDateString('fr-FR');
                document.getElementById('modal-objet').textContent = formData.get('objet');
                document.getElementById('modal-total-ht').textContent = parseFloat(formData.get('total_ht') || 0).toFixed(2) + ' MAD';
                document.getElementById('modal-total-remise').textContent = parseFloat(formData.get('total_remise') || 0).toFixed(2) + ' MAD';
                document.getElementById('modal-total-tva').textContent = parseFloat(formData.get('total_tva') || 0).toFixed(2) + ' MAD';
                document.getElementById('modal-total-ttc').textContent = parseFloat(formData.get('total_ttc') || 0).toFixed(2) + ' MAD';

                if (factureId) {
                    document.getElementById('modal-btn-pdf').href = `/facture/${factureId}/pdf`;
                    document.getElementById('modal-btn-email').onclick = () => sendInvoiceByEmail(factureId);
                    document.getElementById('modal-btn-print').onclick = () => window.open(`/facture/${factureId}/print`, '_blank');
                    document.getElementById('modal-btn-pdf').classList.remove('disabled');
                } else {
                    document.getElementById('modal-btn-pdf').removeAttribute('href');
                    document.getElementById('modal-btn-email').onclick = null;
                    document.getElementById('modal-btn-print').onclick = null;
                }

                myModal.show();
            })
            .catch(error => {
                console.error('Erreur:', error);
                //alert('Impossible de contacter le serveur en AJAX. Essayez d\\'enregistrer la facture d\\'abord.');
            });
        });
    } else {
        //console.error(\"Bootstrap n'est pas charg√©. La modale ne peut pas fonctionner.\");
    }

    // Diagnostic console (utile pour debug)
    ['addLigne','addSectionBtn','btn-save-draft','btn-open-modal','form_facture'].forEach(id => {
        const el = document.getElementById(id);
        if (el) console.log(`‚úÖ √âl√©ment trouv√© : ${id}`);
        else console.warn(`‚ùå √âl√©ment manquant : ${id}`);
    });
});

function sendInvoiceByEmail(factureId) {
    //alert(`Fonctionnalit√© \"Envoyer par email\" pour la facture ${factureId} √† impl√©menter.`);
}
// üîπ Calcul dynamique des retenues globales + Net √† payer
document.addEventListener("DOMContentLoaded", function () {
    // üîπ Champs de taux (%)
    const retenueSourceTaux = document.querySelector('input[name="retenue_source_globale"]') 
        || document.querySelector('input[name="retenue_source"]');
    const retenueGarantieTaux = document.querySelector('input[name="retenue_garantie_globale"]') 
        || document.querySelector('input[name="retenue_garantie"]');

    // üîπ Champs de montants
    const totalHT = document.querySelector('input[name="total_ht"]');
    const totalRemise = document.querySelector('input[name="total_remise"]');
    const totalTVA = document.querySelector('input[name="total_tva"]');
    const totalTTC = document.querySelector('input[name="total_ttc"]');
    const totalRetenueSource = document.querySelector('input[name="total_retenue_source"]');
    const totalRetenueGarantie = document.querySelector('input[name="total_retenue_garantie"]');
    const netAPayer = document.querySelector('input[name="net_a_payer"]');

    // üîß Fonction principale
    function updateGlobalRetenues() {
        try {
            const ht = parseFloat(totalHT?.value) || 0;
            const remise = parseFloat(totalRemise?.value) || 0;
            const tva = parseFloat(totalTVA?.value) || 0;

            // ‚úÖ Base de calcul : HT - Remise + TVA
            const base = ht - remise + tva;

            // ‚úÖ Lecture des taux
            const tauxSource = parseFloat(retenueSourceTaux?.value) || 0;
            const tauxGarantie = parseFloat(retenueGarantieTaux?.value) || 0;

            // ‚úÖ Calcul des retenues
            const retenueSourceMontant = base * (tauxSource / 100);
            const retenueGarantieMontant = base * (tauxGarantie / 100);

            // ‚úÖ Calcul du net √† payer
            const totalNet = base - retenueSourceMontant - retenueGarantieMontant;

            // ‚úÖ Mise √† jour des champs
            if (totalRetenueSource) totalRetenueSource.value = retenueSourceMontant.toFixed(2);
            if (totalRetenueGarantie) totalRetenueGarantie.value = retenueGarantieMontant.toFixed(2);
            if (totalTTC) totalTTC.value = totalNet.toFixed(2);
            if (netAPayer) netAPayer.value = totalNet.toFixed(2);
        } catch (err) {
            console.warn("‚ö†Ô∏è Erreur updateGlobalRetenues:", err);
        }
    }

    // üîÅ Recalcul quand on modifie un taux ou un montant
    [retenueSourceTaux, retenueGarantieTaux, totalHT, totalRemise, totalTVA].forEach(el => {
        if (el) el.addEventListener("input", updateGlobalRetenues);
    });

    // üîÅ Recalcul apr√®s modification d‚Äôune ligne produit
    document.addEventListener("input", function (e) {
        const name = e.target.name || '';
        if (["quantite", "prix_ht", "tva", "remise"].some(n => name.includes(n))) {
            updateGlobalRetenues();
        }
    });

    // ‚öôÔ∏è Premier calcul au chargement
    updateGlobalRetenues();

    // üîÑ Si calculateTotals existe, on l‚Äôenrichit pour recalculer les retenues √† chaque total
    if (typeof calculateTotals === "function") {
        const originalCalculateTotals = calculateTotals;
        calculateTotals = function () {
            originalCalculateTotals();
            updateGlobalRetenues(); // ‚úÖ recalcul automatique des retenues apr√®s chaque total
        };
    }
});

</script>
<script>
// ‚úÖ Script complet pour synchroniser les labels √† gauche et √† droite
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const champs = [
            {
                input: 'input[name="retenue_source_globale"]',
                labelGauche: 'label-retenue-source',
                labelDroite: 'label-retenue-source-droite',
                texteBase: 'Retenue √† la source'
            },
            {
                input: 'input[name="retenue_garantie_globale"]',
                labelGauche: 'label-retenue-garantie',
                labelDroite: 'label-retenue-garantie-droite',
                texteBase: 'Retenue de garantie'
            },
            {
                input: 'input[name="remise_globale"]',
                labelGauche: 'label-remise-globale',
                labelDroite: 'label-remise-globale-droite',
                texteBase: 'Remise globale'
            }
        ];

        champs.forEach(({ input, labelGauche, labelDroite, texteBase }) => {
            const inputEl = document.querySelector(input);
            const labelG = document.getElementById(labelGauche);
            const labelD = document.getElementById(labelDroite);

            if (inputEl) {
                const majLabel = () => {
                    const taux = parseFloat(inputEl.value) || 0;
                    const texte = taux > 0
                        ? `${texteBase} (${taux}%) :`
                        : `${texteBase} (%) :`;
                    if (labelG) labelG.textContent = texte;
                    if (labelD) labelD.textContent = texte;
                };

                inputEl.addEventListener('input', () => {
                    majLabel();
                    if (typeof calculateTotals === 'function') calculateTotals();
                });

                majLabel(); // Met √† jour au chargement
            }
        });
    }, 100);
});
</script>

{% endblock %}